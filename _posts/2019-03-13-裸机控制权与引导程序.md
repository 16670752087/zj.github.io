---
categories: 操作系统
---
# 实验题目
裸机控制权与引导程序
# 实验目的
- 搭建好操作系统的实验环境，安装虚拟机，生成虚拟软盘
- 编写简单的汇编程序接管裸机的控制权，并添加其他显示特性
- 将汇编程序放入虚拟软盘中，引导虚拟机启动

# 实验要求
## 搭建和应用实验环境
虚拟机安装，生成一个基本配置的虚拟机XXXPC和多个1.44MB容量的虚拟软盘，将其中一个虚拟软盘用DOS格式化为DOS引导盘，用WinHex工具将其中一个虚拟软盘的首扇区填满你的个人信息。
## 接管裸机的控制权
设计IBM_PC的一个引导扇区程序，程序功能是：用字符‘A’从屏幕左边某行位置45度角下斜射出，保持一个可观察的适当速度直线运动，碰到屏幕的边后产生反射，改变方向运动，如此类推，不断运动；在此基础上，增加你的个性扩展，如同时控制两个运动的轨迹，或炫酷动态变色，个性画面，如此等等，自由不限。还要在屏幕某个区域特别的方式显示你的学号姓名等个人信息。将这个程序的机器码放进放进第三张虚拟软盘的首扇区，并用此软盘引导你的XXXPC，直到成功。
# 实验方案
## 实验环境
### 软件
- Windows 10, 64-bit  (Build 17763) 10.0.17763
- Windows Subsystem for Linux [Ubuntu 18.04.2 LTS]：WSL是以软件的形式运行在Windows下的Linux子系统，是近些年微软推出来的新工具，可以在Windows系统上原生运行Linux。较之于双系统虚拟机等其他开发方案，更加方便。
- gcc version 7.3.0 (Ubuntu 7.3.0-27ubuntu1~18.04)：C语言程序编译器，Ubuntu自带。
- NASM version 2.13.02：汇编程序编译器，通过`sudo apt install nasm`安装在WSL上。
- Oracle VM VirtualBox 6.0.4 r128413 (Qt5.6.2)：轻量开源的虚拟机软件。
- VSCode - Insiders v1.33.0：好用的文本编辑器，有丰富的插件。
- hexdump for VSCode: VSCode中一个好用的十六进制显示插件。

### 硬件
#### 开发环境配置
所用机器型号为VAIO Z Flip 2016
 - Intel(R) Core(TM) i7-6567U CPU @3.30GHZ 3.31GHz
 - 8.00GB RAM

#### 虚拟机配置
 - 处理器内核总数：1
 - RAM：4MB

包括：硬件或虚拟机配置方法、软件工具与作用、方案的思想、相关知识原理、程序流程、算法和数据结构、程序关键模块，结合代码与程序中的位置位置进行解释。
# 实验过程
## 搭建和应用实验环境
### 安装、配置虚拟机
1. 打开Oracle VM VirtualBox
2. 点新建，名称填“WuKPC”，并指定位置，类型选“Other”，版本选择“Other/Unknown”，点“下一步”
3. 内存选4MB
4. 选不添加虚拟硬盘

### 创建并格式化虚拟软盘
Linux上可以直接用如下的指令创建虚拟软盘，其中要注意的是1.44MB=1440KB。
```bash
/sbin/mkfs.msdos -C a.img 1440
```
同目录下出现`a.img`，得到如下反馈
```
mkfs.fat 4.1 (2017-01-24)
```
这说明生成的虚拟软盘已经自动格式化了。打开“设置”-“存储”-“添加软盘驱动器”-“完成”，然后在新生成的控制器中添加虚拟软驱，点“注册”，打开刚刚生成的“a.img”，并确认。

现在开启虚拟机，发现虚拟机的屏幕上已经有了显示:
```
This is not a bootable disk.  Please insert a bootable floppy and press any key to try again ...
```
这说明虚拟软盘格式化成功。
### 填满个人信息
使用hexdump for VSCode打开刚刚创建的`a.img`，发现其有着如下的结构（以下仅截取前三十四行）:
```
  Offset: 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F
00000000: EB 3C 90 6D 6B 66 73 2E 66 61 74 00 02 01 01 00    k<.mkfs.fat.....
00000010: 02 E0 00 40 0B F0 09 00 12 00 02 00 00 00 00 00    .`.@.p..........
00000020: 00 00 00 00 00 00 29 95 B1 98 3C 4E 4F 20 4E 41    ......).1.<NO.NA
00000030: 4D 45 20 20 20 20 46 41 54 31 32 20 20 20 0E 1F    ME....FAT12.....
00000040: BE 5B 7C AC 22 C0 74 0B 56 B4 0E BB 07 00 CD 10    >[|,"@t.V4.;..M.
00000050: 5E EB F0 32 E4 CD 16 CD 19 EB FE 54 68 69 73 20    ^kp2dM.M.k~This.
00000060: 69 73 20 6E 6F 74 20 61 20 62 6F 6F 74 61 62 6C    is.not.a.bootabl
00000070: 65 20 64 69 73 6B 2E 20 20 50 6C 65 61 73 65 20    e.disk...Please.
00000080: 69 6E 73 65 72 74 20 61 20 62 6F 6F 74 61 62 6C    insert.a.bootabl
00000090: 65 20 66 6C 6F 70 70 79 20 61 6E 64 0D 0A 70 72    e.floppy.and..pr
000000a0: 65 73 73 20 61 6E 79 20 6B 65 79 20 74 6F 20 74    ess.any.key.to.t
000000b0: 72 79 20 61 67 61 69 6E 20 2E 2E 2E 20 0D 0A 00    ry.again........
000000c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
000000d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
000000e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
000000f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
00000100: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
00000110: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
00000120: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
00000130: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
00000140: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
00000150: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
00000160: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
00000170: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
00000180: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
00000190: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
000001a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
000001b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
000001c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
000001d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
000001e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
000001f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 55 AA    ..............U*
00000200: F0 FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00    p...............
```
要填满在第一个扇区除了引导区之外填满个人信息，只需要在`0x500B`~`0x1f00D`间填满个人信息即可。这里直接偷懒用一段C解决：
```c
#include <stdio.h>
char s[] = "17341163-wu-kan-", b[1440 << 10];
int main()
{
	fread(b, sizeof(*b), sizeof(b), fopen("a.img", "rb+"));
	for (int i = 91; i < 510; ++i)
		b[i] = s[i % (sizeof(s) - 1)];
	fwrite(b, sizeof(*b), sizeof(b), fopen("b.img", "wb"));
}
```
运行得到的`b.img`，其十六进制有着如下的结构，可以发现已经填充成功。
```
  Offset: 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F
00000000: EB 3C 90 6D 6B 66 73 2E 66 61 74 00 02 01 01 00    k<.mkfs.fat.....
00000010: 02 E0 00 40 0B F0 09 00 12 00 02 00 00 00 00 00    .`.@.p..........
00000020: 00 00 00 00 00 00 29 B9 CA 4B BC 4E 4F 20 4E 41    ......)9JK<NO.NA
00000030: 4D 45 20 20 20 20 46 41 54 31 32 20 20 20 0E 1F    ME....FAT12.....
00000040: BE 5B 7C AC 22 C0 74 0B 56 B4 0E BB 07 00 CD 10    >[|,"@t.V4.;..M.
00000050: 5E EB F0 32 E4 CD 16 CD 19 EB FE 2D 6B 61 6E 2D    ^kp2dM.M.k~-kan-
00000060: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
00000070: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
00000080: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
00000090: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
000000a0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
000000b0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
000000c0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
000000d0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
000000e0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
000000f0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
00000100: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
00000110: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
00000120: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
00000130: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
00000140: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
00000150: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
00000160: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
00000170: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
00000180: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
00000190: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
000001a0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
000001b0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
000001c0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
000001d0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
000001e0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 2D    17341163-wu-kan-
000001f0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 55 AA    17341163-wu-kaU*
00000200: F0 FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00    p...............
```
用虚拟机打开b.img，发现成功。耶！
## 接管裸机的控制权
重构了老师的代码，删掉了很多没有用的语句。
```nasm
	DNRT equ 1	; D-Down,U-Up,R-right,L-Left
	UPRT equ 2
	UPLT equ 3
	DNLT equ 4
	WIDTH equ 80
	HEIGHT equ 25
	LENGTH equ 15	; 字符串的长度
org 7c00h
section .data
	count dd 1
	x dw 0
	y dw 0
	rdul db DNRT	; 向右下运动
	message db '17341163-wu-kan'
section .text
	mov ax,0B800h
	mov gs,ax	; GS = 0xB800h，文本窗口显存起始地址
myLoop:
	dec dword[count]	; 递减计数变量
	jnz myLoop	; >0：跳转;
	mov dword[count],99999999
	cmp byte[rdul],DNRT
	jz  dnrt
	cmp byte[rdul],UPRT
	jz  uprt
	cmp byte[rdul],UPLT
	jz  uplt
	cmp byte[rdul],DNLT
	jz  dnlt
dnrt:
	inc word[x]
	inc word[y]
	mov ax,HEIGHT
	sub ax,word[x]
	jz  dr2ur
	mov ax,WIDTH-LENGTH
	sub ax,word[y]
	jz  dr2dl
	jmp show
dr2ur:
	mov word[x],HEIGHT-2
	mov byte[rdul],UPRT
	jmp show
dr2dl:
	mov word[y],WIDTH-LENGTH
	mov byte[rdul],DNLT
	jmp show
uprt:
	dec word[x]
	inc word[y]
	mov ax,WIDTH-LENGTH
	sub ax,word[y]
	jz  ur2ul
	mov ax,-1
	sub ax,word[x]
	jz  ur2dr
	jmp show
ur2ul:
	mov word[y],WIDTH-LENGTH
	mov byte[rdul],UPLT
	jmp show
ur2dr:
	mov word[x],1
	mov byte[rdul],DNRT
	jmp show
uplt:
	dec word[x]
	dec word[y]
	mov ax,-1
	sub ax,word[x]
	jz  ul2dl
	mov ax,-1
	sub ax,word[y]
	jz  ul2ur
	jmp show
ul2dl:
	mov word[x],1
	mov byte[rdul],DNLT
	jmp show
ul2ur:
	mov word[y],1
	mov byte[rdul],UPRT
	jmp show
dnlt:
	inc word[x]
	dec word[y]
	mov ax,-1
	sub ax,word[y]
	jz  dl2dr
	mov ax,HEIGHT
	sub ax,word[x]
	jz  dl2ul
	jmp show
dl2dr:
	mov word[y],1
	mov byte[rdul],DNRT
	jmp show
dl2ul:
	mov word[x],HEIGHT-2
	mov byte[rdul],UPLT
	jmp show
show:
	mov byte ah,0
	mov byte al,0
	mov bx,0
	mov cx,2000
	black:
		mov [gs:bx],ax
		inc bx
		inc bx
	loop black
	xor ax,ax
	mov word ax,[x]
	mov bx,WIDTH
	mul bx
	add word ax,[y]
	mov bx,2
	mul bx
	mov bx,ax
	mov si, message
	mov cx, LENGTH
	printStr:
		mov byte ah,0Fh
		mov byte al,[si]
		mov [gs:bx],ax
		inc si
		inc bx
		inc bx
	loop printStr
	jmp myLoop
```
依次执行下列bash指令，将上述汇编代码编译并写进新的软驱c.img
```bash
nasm c.asm -o c.bin
/sbin/mkfs.msdos -C c.img 1440
dd if=c.bin of=c.img bs=1440k conv=notrunc
```
上面生成的代码只有356Byte。
包括：主要工具安装使用过程及截图结果、程序过程中的操作步骤、测试数据、输入及输出说明、遇到的问题及解决情况、关键功能或操作的截图结果。
# 实验总结
每人必需写一段心得体会、问题讨论与思考、新的设想等，文字不少于500字，可以写感言、作总结或提建议。不得抄袭，否则按作弊处理。
# 参考文献
如有要列出，包括网上资源
